{% comment %} Custom Header Section {% endcomment %}
<header class="header" data-fls-header data-fls-header-scroll="80" data-fls-header-scroll-show>
  <div class="header__container">
    <div class="header__content">
      <div class="header__menu menu">
        <button type="button" data-fls-menu class="menu__icon icon-menu">
          <span></span>
        </button>
		
        <nav class="menu__body">
          <ul class="menu__list">
            {% assign menu = linklists[section.settings.main_menu] %}
            {% for link in menu.links %}
              {% assign submenu_block = null %}
              {% for block in section.blocks %}
                {% if block.settings.menu_item_title == link.title %}
                  {% assign submenu_block = block %}
                  {% break %}
                {% endif %}
			{% endfor %}

              <li class="menu__item {% if link.links.size > 0 %}menu__item--parent{% endif %}">
                <a href="{{ link.url }}" class="menu__link">{{ link.title }}</a>

                {% if link.links.size > 0 %}
                  <span class="menu__arrow-submenu --icon-arrow"></span>
                  <div class="menu__submenu submenu-header">
                    <div class="submenu-header__content">
                      <div class="submenu-header__left">
                        <ul class="submenu-header__list-extra">
                          {% for sublink in link.links %}
                            <li class="submenu-header__item-extra{% if forloop.index > 1 %} submenu-header__item-extra--hidden{% endif %}">
                              <a href="{{ sublink.url }}" class="submenu-header__link-extra">{{ sublink.title }}</a>
                            </li>
                          {% endfor %}
                        </ul>
                        {% if submenu_block and submenu_block.settings.subtitle != blank %}
                          <div class="submenu-header__title">{{ submenu_block.settings.subtitle }}</div>
                        {% endif %}
                      </div>

                      {% if submenu_block and submenu_block.settings.image != blank %}
                        <div class="submenu-header__right">
                          <a href="{{ link.url }}" class="submenu-header__link">
                            <img class="submenu-header__image ibg"
                                 src="{{ submenu_block.settings.image | image_url }}"
                                 alt="{{ submenu_block.settings.image.alt }}">
                          </a>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
              </li>
            {% endfor %}

            <li class="menu__item menu__item--user"></li>
          </ul>

          <ul class="menu__lang-list">
            {% for locale in localization.available_languages %}
              <li class="menu__lang-item">
                <a href="#" class="{% if locale.iso_code == localization.language.iso_code %}menu__lang-current{% else %}menu__lang-link{% endif %}">
                  {{ locale.iso_code | upcase }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </nav>
      </div>

      <div class="header__logo-block">
        <a href="{{ routes.root_url }}" class="header__logo">
          {% if section.settings.logo != blank %}
            <img src="{{ section.settings.logo | image_url }}" alt="{{ section.settings.logo.alt }}">
          {% else %}
            {{ shop.name }}
          {% endif %}
        </a>
      </div>

      <div class="header__actions actions-header">
        <select class="actions-header__lang" name="form[]" data-fls-select data-fls-select-modif="form">
          {% for locale in localization.available_languages %}
            <option value="{{ locale.iso_code | downcase }}" {% if locale.iso_code == localization.language.iso_code %}selected{% endif %}>
              {{ locale.iso_code | upcase }}
            </option>
          {% endfor %}
        </select>

        <div class="actions-header__icons">
          <a href="{{ section.settings.wishlist_url }}" class="actions-header__bookmarks">
            <span class="--icon-heart"></span>
            <span class="--icon-heart-hover"></span>
          </a>
          <a href="{{ routes.account_url }}" data-fls-dynamic=".menu__item--user, 768" class="actions-header__user --icon-user">Log in</a>
          <button type="button" class="actions-header__cart --icon-bag"></button>
        </div>
      </div>
    </div>
  </div>
</header>

<script>
  const getRedirectUrl = (langCode) => {
    const currentLocale = Shopify.locale?.toLowerCase();
    const defaultLocale = 'en';
    if (langCode === currentLocale) return null;

    const path = window.location.pathname.replace(/^\/[a-z]{2}(\/|$)/, '/');
    const query = window.location.search;

    return langCode === defaultLocale
      ? `${path}${query}`
      : `/${langCode}${path}${query}`;
  };

  document.addEventListener("selectCallback", function (e) {
    const select = e.detail.select;
    const value = select.value?.toLowerCase();
    if (!value) return;

    const redirectUrl = getRedirectUrl(value);
    if (redirectUrl) window.location.href = redirectUrl;
  });

  document.addEventListener("DOMContentLoaded", () => {
    const langLinks = document.querySelectorAll('.menu__lang-list a');
    langLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const langCode = link.textContent.trim().toLowerCase();
        const redirectUrl = getRedirectUrl(langCode);
        if (redirectUrl) window.location.href = redirectUrl;
      });
    });
  });
</script>

{% schema %}
{
  "name": "Custom Header",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo"
    },
    {
      "type": "link_list",
      "id": "main_menu",
      "label": "Main menu"
    },
    {
      "type": "url",
      "id": "wishlist_url",
      "label": "Wishlist URL"
    }
  ],
  "blocks": [
    {
      "type": "menu_image",
      "name": "Submenu content",
      "settings": [
        {
          "type": "text",
          "id": "menu_item_title",
          "label": "Menu item title",
          "info": "Must match a top-level menu item title"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Submenu image"
        },
        {
          "type": "text",
          "id": "subtitle",
          "label": "Submenu subtitle"
        }
      ]
    }
  ],
  "max_blocks": 10,
  "presets": [
    {
      "name": "Custom Header",
      "category": "Header"
    }
  ]
}
{% endschema %}
